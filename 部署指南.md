# Daily Stock Analysis 项目部署运维文档

本文档记录了在 Linux 服务器（Ubuntu/Debian）上部署 `daily_stock` 项目的完整流程。
本方案采用 **PM2** 进行进程管理（支持崩溃自动重启、开机自启），并使用 **Nginx** 作为反向代理，配合独立域名 `warmmilk.fun`。

> [!IMPORTANT]
> **外网部署安全提示**
> 1. **修改默认密码**: 部署后必须立即在 `.env` 中修改 `WEB_USERNAME` 和 `WEB_PASSWORD`。
> 2. **启用 HTTPS**: 强烈建议通过 Nginx 配置 SSL 证书，以防凭据明文传输。

---

## 0. 部署前准备

- **项目路径**: `/home/daily_stock_analysis`
- **监听端口**: Python 后端运行在 `10089`，Nginx 对外暴露 `80`/`443`。

## 1. Python 环境搭建

### 1.1 安装基础环境
如果系统较新（如 Ubuntu 24.04+），需要先安装 `python3-full`：

```bash
sudo apt update
sudo apt install python3-full -y
```

### 1.2 创建与配置虚拟环境
在项目根目录下执行：

```bash
cd /home/daily_stock_analysis

# 创建虚拟环境
python3 -m venv venv

# 激活环境
source venv/bin/activate

# 安装项目依赖
pip install -r requirements.txt

# 退出虚拟环境
deactivate
```

## 2. 安装与配置 PM2 (进程管理)

### 2.1 安装 PM2
PM2 基于 Node.js，需先安装 `npm`：

```bash
# 安装 npm
sudo apt install npm -y

# 全局安装 PM2
sudo npm install pm2 -g
```

### 2.2 启动项目
使用 PM2 启动 Python 脚本，并指定虚拟环境解释器：

```bash
cd /home/daily_stock_analysis

# 启动命令详解：
# --name: 进程名称
# --interpreter: 指定虚拟环境中的 Python 路径
# --: 分隔符，其后的参数将传递给 Python 脚本（重要）
pm2 start main.py --name "daily_stock" --interpreter ./venv/bin/python -- --serve-only
```

### 2.3 设置开机自启
确保服务器重启后服务能自动恢复：

```bash
# 1. 保存当前运行状态
pm2 save

# 2. 生成自启脚本
# 执行后请根据终端提示，复制并运行生成的命令
pm2 startup
```

### 2.4 查看运行状态
```bash
pm2 list
```
> **Status** 应显示为 `online`。

---

## 3. 域名解析与服务器配置

### 3.1 配置 DNS 解析
在域名服务商控制台（如腾讯云、阿里云）添加以下 A 记录：

| 主机记录 (Host) | 记录类型 (Type) | 记录值 (Value) |
| :--- | :--- | :--- |
| `@` | A | 您的服务器公网 IP |
| `www` | A | 您的服务器公网 IP |

> [!NOTE]
> 解析生效通常需要 1-10 分钟。

### 3.2 开放安全组端口
在云平台控制台（阿里云/腾讯云）放行以下端口：
- **TCP 80** (HTTP)
- **TCP 443** (HTTPS)

> [!TIP]
> 建议关闭 **10089** 端口的外部访问，仅允许本地 Nginx 转发，以提高安全性。

---

## 4. 配置 Nginx 反向代理

### 4.1 安装 Nginx
```bash
sudo apt install nginx -y
```

### 4.2 创建站点配置
```bash
sudo vim /etc/nginx/sites-available/daily_stock
```

**配置文件内容：**
```nginx
server {
    listen 80;
    server_name warmmilk.fun www.warmmilk.fun;

    location / {
        # 转发至本地 Python 服务
        proxy_pass http://127.0.0.1:10089;
        
        # 传递客户端真实 IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持 (WebUI 交互所需)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 4.3 启用配置
```bash
# 1. 建立软链接
sudo ln -s /etc/nginx/sites-available/daily_stock /etc/nginx/sites-enabled/

# 2. 移除默认配置
sudo rm /etc/nginx/sites-enabled/default

# 3. 检查语法并重载
sudo nginx -t
sudo systemctl reload nginx
```

---

## 5. 配置 HTTPS (SSL 证书)

使用 **Certbot** 为域名开启强制 HTTPS：

```bash
# 1. 安装工具
sudo apt install certbot python3-certbot-nginx -y

# 2. 自动申请并配置证书
sudo certbot --nginx -d warmmilk.fun -d www.warmmilk.fun
```
> [!NOTE]
> 过程中请选择 `2 (Redirect)` 以便将所有 HTTP 请求重定向至 HTTPS。

---

## 6. 日常运维指南 (PM2)

| 操作 | 命令 |
| :--- | :--- |
| **查看实时日志** | `pm2 logs daily_stock` |
| **重启进程** | `pm2 restart daily_stock` |
| **停止进程** | `pm2 stop daily_stock` |
| **查看进程列表** | `pm2 list` |
| **监控系统资源** | `pm2 monit` |